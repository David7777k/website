# Changelog v2.1 - PANDA Lounge

## üé° **–ï—Ç–∞–ø 1 COMPLETED: –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω–∏ - –°—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å —Ç–∞ FSM**

### ‚úÖ –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ

#### 1. **–ü–æ–∫—Ä–∞—â–µ–Ω–∞ Finite State Machine (FSM)**
- **–°—Ç–∞–Ω–∏**: `LOCKED` ‚Üí `READY` ‚Üí `SPINNING` ‚Üí `RESULT` ‚Üí `COOLDOWN` ‚Üí `ERROR`
- **LOCKED**: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π
- **READY**: –ú–æ–∂–µ –∫—Ä—É—Ç–∏—Ç–∏ –∫–æ–ª–µ—Å–æ
- **SPINNING**: –ü—Ä–æ—Ü–µ—Å –æ–±–µ—Ä—Ç–∞–Ω–Ω—è (–∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –ø–æ–≤—Ç–æ—Ä–Ω—ñ –∫–ª—ñ–∫–∏)
- **RESULT**: –ü–æ–∫–∞–∑ –≤–∏–≥—Ä–∞–Ω–æ–≥–æ –ø—Ä–∏–∑—É (8 —Å–µ–∫—É–Ω–¥)
- **COOLDOWN**: –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –Ω–∞ 7 –¥–Ω—ñ–≤ –ø—ñ—Å–ª—è —Å–ø—ñ–Ω—É
- **ERROR**: –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ –∑ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏

#### 2. **–ö–ª—ñ—î–Ω—Ç—Å—å–∫–∞ —á–∞—Å—Ç–∏–Ω–∞ (WheelModal.tsx)**
- ‚úÖ –î–æ–¥–∞–Ω–æ `useCallback` –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó —Ö—É–∫—ñ–≤
- ‚úÖ –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –±–∞–≥–∞—Ç–æ—Ä–∞–∑–æ–≤–∏—Ö –∫–ª—ñ–∫—ñ–≤ (`isSpinning` state)
- ‚úÖ –†–µ—Ñ–µ—Ä–µ–Ω—Å–∏ –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è race conditions (`spinAttemptRef`)
- ‚úÖ –ü–æ–∫—Ä–∞—â–µ–Ω—ñ –≤—ñ–∑—É–∞–ª—å–Ω—ñ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Å—Ç–∞–Ω—É
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –∑ –ø—Ä–æ–º–æ–∫–æ–¥–æ–º
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ RESULT ‚Üí COOLDOWN (8 —Å–µ–∫)
- ‚úÖ –ê–Ω—ñ–º–∞—Ü—ñ—è —Å–ø—ñ–Ω—É –∑ –≤–∏–ø–∞–¥–∫–æ–≤–∏–º offset'–æ–º –¥–ª—è —Ä–µ–∞–ª—ñ—Å—Ç–∏—á–Ω–æ—Å—Ç—ñ
- ‚úÖ –ü–æ–∫–∞–∑ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ –≤—ñ–¥–ª—ñ–∫—É –ø—Ä–∏ COOLDOWN
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–ú–æ—ó –∫—É–ø–æ–Ω–∏" –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥—É –≤ –ø—Ä–æ—Ñ—ñ–ª—å

#### 3. **–°–µ—Ä–≤–µ—Ä–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞ (API Routes)**

**POST /api/wheel/spin:**
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è (logger utility)
- ‚úÖ Request ID –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥—É
- ‚úÖ –í–∞–ª—ñ–¥–∞—Ü—ñ—è distribution –ø—Ä–∏–∑—ñ–≤ (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ totalProbability > 0)
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∏–π audit log –¥–ª—è –∫–æ–∂–Ω–æ—ó –¥—ñ—ó:
  - `wheel_spin_attempt` - —Å–ø—Ä–æ–±–∞ —Å–ø—ñ–Ω—É
  - `wheel_spin_blocked` - –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –ø—Ä–∏ cooldown
  - `wheel_spin_success` - —É—Å–ø—ñ—à–Ω–∏–π —Å–ø—ñ–Ω
  - `wheel_spin_error` - –ø–æ–º–∏–ª–∫–∞
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π–Ω–∞ –≤–∏–¥–∞—á–∞ –ø—Ä–∏–∑—ñ–≤ (WheelSpin + Coupon + AuditLog)
- ‚úÖ IP tracking —Ç–∞ User-Agent –¥–ª—è –∞–Ω—Ç–∏-–∞–±—É–∑
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –ø—Ä–æ–º–æ–∫–æ–¥—É –∑ —Ç–µ—Ä–º—ñ–Ω–æ–º –¥—ñ—ó 7 –¥–Ω—ñ–≤
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫–∏

**GET /api/wheel/status:**
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
- ‚úÖ FSM —Å—Ç–∞–Ω–∏: LOCKED, READY, COOLDOWN
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∏–π timeLeft (days, hours, minutes)
- ‚úÖ –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –æ—Å—Ç–∞–Ω–Ω—ñ–π –≤–∏–≥—Ä–∞—à
- ‚úÖ –í–∞–ª—ñ–¥–∞—Ü—ñ—è –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó

#### 4. **–°—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–µ –õ–æ–≥—É–≤–∞–Ω–Ω—è (/lib/logger.ts)**
- ‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ Logger utility class
- ‚úÖ –†—ñ–≤–Ω—ñ –ª–æ–≥—É–≤–∞–Ω–Ω—è: info, warn, error, debug
- ‚úÖ –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è JSON –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏—Ö –ª–æ–≥—ñ–≤
- ‚úÖ Integration –∑ Prisma AuditLog
- ‚úÖ Request ID tracking
- ‚úÖ IP —Ç–∞ User-Agent logging
- ‚úÖ Error stack traces

#### 5. **–ë–∞–∑–∞ –î–∞–Ω–∏—Ö**
–Ü—Å–Ω—É—é—á—ñ –º–æ–¥–µ–ª—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –±–µ–∑ –∑–º—ñ–Ω:
- `WheelSpin`: userId, prizeId, prizeName, state, nextAllowedAt, ip
- `WheelPrize`: name, type, value, probability, maxPerPeriod, isActive
- `Coupon`: code, type, valuePct, expiresAt, userId
- `AuditLog`: userId, action, entityType, details, ip, userAgent

### üîí **–ë–µ–∑–ø–µ–∫–∞ —Ç–∞ –ê–Ω—Ç—ñ-–ê–±—É–∑**
- ‚úÖ 7-–¥–µ–Ω–Ω–∏–π –∫—É–ª–¥–∞—É–Ω –º—ñ–∂ —Å–ø—ñ–Ω–∞–º–∏
- ‚úÖ IP —Ç–∞ fingerprint tracking
- ‚úÖ Audit logging –≤—Å—ñ—Ö —Å–ø—Ä–æ–±
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π–Ω–∞ –≤–∏–¥–∞—á–∞ –ø—Ä–∏–∑—ñ–≤ (–∞—Ç–æ–º–∞—Ä–Ω—ñ—Å—Ç—å)
- ‚úÖ –í–∞–ª—ñ–¥–∞—Ü—ñ—è prize distribution
- ‚úÖ –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ concurrent spins
- ‚úÖ Request ID –¥–ª—è trace debugging

### üìä **–°–ø–æ—Å—Ç–µ—Ä–µ–∂–Ω—ñ—Å—Ç—å (Observability)**
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ JSON –ª–æ–≥–∏
- ‚úÖ Action tracking: attempt, blocked, success, error
- ‚úÖ Performance metrics (—á–µ—Ä–µ–∑ timestamps)
- ‚úÖ Error stack traces –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- ‚úÖ User behavior tracking (IP, UA, timeLeft)

### üé® **UX –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è**
- ‚úÖ –ß—ñ—Ç–∫—ñ –≤—ñ–∑—É–∞–ª—å–Ω—ñ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ —Å—Ç–∞–Ω—ñ–≤
- ‚úÖ –Ü–∫–æ–Ω–∫–∏ —Ç–∞ –µ–º–æ–¥–∂—ñ –¥–ª—è –∫—Ä–∞—â–æ–≥–æ UX
- ‚úÖ –ê–Ω—ñ–º–∞—Ü—ñ—è —Å–ø—ñ–Ω—É –∑ —Ä–µ–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–º —Ä–∞–Ω–¥–æ–º–æ–º
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∏–π –ø–æ–∫–∞–∑ –≤–∏–≥—Ä–∞—à—É –∑ –ø—Ä–æ–º–æ–∫–æ–¥–æ–º
- ‚úÖ –ö–Ω–æ–ø–∫–∏ "–ú–æ—ó –∫—É–ø–æ–Ω–∏" —Ç–∞ "–ó–∞–∫—Ä–∏—Ç–∏"
- ‚úÖ –¢–∞–π–º–µ—Ä –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ –≤—ñ–¥–ª—ñ–∫—É (–¥–Ω—ñ, –≥–æ–¥–∏–Ω–∏, —Ö–≤–∏–ª–∏–Ω–∏)
- ‚úÖ –û—Å—Ç–∞–Ω–Ω—ñ–π –≤–∏–≥—Ä–∞—à –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –ø—Ä–∏ COOLDOWN

### üß™ **–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è**
- ‚ö†Ô∏è –ü–æ—Ç—Ä—ñ–±–Ω–µ —Ä—É—á–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è:
  1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è ‚Üí –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –∫–æ–ª–µ—Å–∞
  2. –ü–µ—Ä—à–∏–π —Å–ø—ñ–Ω ‚Üí –≤–∏–≥—Ä–∞—à ‚Üí –ø–æ–∫–∞–∑ –ø—Ä–æ–º–æ–∫–æ–¥—É
  3. –°–ø—Ä–æ–±–∞ –¥—Ä—É–≥–æ–≥–æ —Å–ø—ñ–Ω—É ‚Üí –±–ª–æ–∫—É–≤–∞–Ω–Ω—è COOLDOWN
  4. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∞–π–º–µ—Ä–∞ –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ –≤—ñ–¥–ª—ñ–∫—É
  5. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–≤ —É –∫–æ–Ω—Å–æ–ª—ñ (structured JSON)

---

## üìã **–ù–∞—Å—Ç—É–ø–Ω—ñ –ï—Ç–∞–ø–∏**

### –ï—Ç–∞–ø 2: NextAuth –°—Ç–∞–±—ñ–ª—ñ–∑–∞—Ü—ñ—è (NEXT)
- [ ] –í–∏–ø—Ä–∞–≤–∏—Ç–∏ CLIENT_FETCH_ERROR
- [ ] –ü–æ–∫—Ä–∞—â–∏—Ç–∏ session handling
- [ ] –î–æ–¥–∞—Ç–∏ redirects –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö

### –ï—Ç–∞–ø 3: –ù–∞–≤—ñ–≥–∞—Ü—ñ—è —Ç–∞ –†–æ—É—Ç–∏–Ω–≥
- [ ] –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—Å—ñ Link –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏
- [ ] –î–æ–¥–∞—Ç–∏ Suspense boundaries
- [ ] Error boundaries –¥–ª—è —Å–µ–∫—Ü—ñ–π

### –ï—Ç–∞–ø 4: –ê–¥–º—ñ–Ω-–ü–∞–Ω–µ–ª—å
- [ ] CRUD –¥–ª—è WheelPrize
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ wheel spins
- [ ] Dashboard –∑ –≥—Ä–∞—Ñ—ñ–∫–∞–º–∏
- [ ] Audit log viewer

---

## üîß **–¢–µ—Ö–Ω—ñ—á–Ω—ñ –î–µ—Ç–∞–ª—ñ**

### –î–æ–¥–∞–Ω—ñ –§–∞–π–ª–∏:
- `/lib/logger.ts` - Structured logging utility

### –ú–æ–¥–∏—Ñ—ñ–∫–æ–≤–∞–Ω—ñ –§–∞–π–ª–∏:
- `/app/components/WheelModal.tsx` - –ü–æ–∫—Ä–∞—â–µ–Ω–∞ FSM —Ç–∞ UI
- `/app/api/wheel/spin/route.ts` - –°—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
- `/app/api/wheel/status/route.ts` - –ü–æ–∫—Ä–∞—â–µ–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è

### –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ:
- –ù–æ–≤—ñ: –Ω–µ–º–∞—î
- –û–Ω–æ–≤–ª–µ–Ω—ñ: –Ω–µ–º–∞—î

### Environment Variables:
- –ë–µ–∑ –∑–º—ñ–Ω (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è —ñ—Å–Ω—É—é—á—ñ)

---

**–í–µ—Ä—Å—ñ—è:** 2.1.0-alpha  
**–î–∞—Ç–∞:** –°—ñ—á–µ–Ω—å 2025  
**–°—Ç–∞—Ç—É—Å –ï—Ç–∞–ø—É 1:** ‚úÖ COMPLETED

**–ù–∞—Å—Ç—É–ø–Ω–∞ —Ü—ñ–ª—å:** –ï—Ç–∞–ø 2 - NextAuth –°—Ç–∞–±—ñ–ª—ñ–∑–∞—Ü—ñ—è
